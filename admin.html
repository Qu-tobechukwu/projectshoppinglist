<!doctype html>
<html>
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin — Stellies</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=DM+Sans:wght@300;400;700&display=swap" rel="stylesheet">
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="assets/logo.svg" type="image/svg+xml">
<link rel="stylesheet" href="style.css" />
<style>
  .admin-wrap{max-width:1100px;margin:18px auto;padding:12px}
  .hidden{display:none}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid rgba(0,0,0,0.06); color:var(--char)}
</style>
</head>
<body>
  <header class="tb">
    <div class="tb-inner">
      <div class="logo-area">
        <a href="index.html"><img src="assets/logo.svg" class="logo" alt="Stellies" /></a>
        <div class="tagline">Admin access</div>
        <hr class="gold-divider" />
      </div>
    </div>
  </header>

  <main class="admin-wrap">
    <div id="loginPanel" class="card">
      <div class="muted">Enter admin password</div>
      <div style="margin-top:8px; display:flex; gap:8px;">
        <input id="adminPw" type="password" placeholder="Admin password" />
        <button id="unlockBtn" class="btn">Unlock</button>
        <button id="clearPending" class="btn ghost">Clear pending (local)</button>
      </div>
      <div class="muted small" style="margin-top:8px">Client-side gate. For full security use server-side auth.</div>
    </div>

    <div id="adminUI" class="hidden">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
        <button id="refreshAdmin" class="btn">Refresh</button>
        <button id="exportCSV" class="btn ghost">Download CSV (static + pending)</button>
        <label class="muted">Show:
          <select id="adminFilter">
            <option value="all">All</option>
            <option value="static">Static</option>
            <option value="pending">Pending</option>
          </select>
        </label>
      </div>

      <div id="summary" class="muted"></div>
      <table id="ordersTable" aria-live="polite">
        <thead><tr><th>Order #</th><th>Name</th><th>Phone</th><th>Delivery</th><th>Items</th><th>Total (R)</th><th>Date</th><th>Packed</th></tr></thead>
        <tbody id="ordersBody"><tr><td colspan="8">Loading…</td></tr></tbody>
      </table>
    </div>
  </main>

<script>
  async function sha256hex(s){
    const enc = new TextEncoder().encode(s);
    const h = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  // SHA256(forphoneuseemail@gmail.com)
  const ADMIN_HASH = '51d8fb68183ff49fa4c539d127879d4360584e197cb76b6901a3c55268748c9f';

  document.getElementById('unlockBtn').addEventListener('click', async () => {
    const pw = document.getElementById('adminPw').value || '';
    if(!pw){ alert('Enter password'); return; }
    const h = await sha256hex(pw);
    if(h === ADMIN_HASH){
      document.getElementById('loginPanel').classList.add('hidden');
      document.getElementById('adminUI').classList.remove('hidden');
      loadOrders();
    } else alert('Incorrect password');
  });

  document.getElementById('clearPending').addEventListener('click', ()=> {
    if(confirm('Clear pending orders in this browser?')){ localStorage.removeItem('stellies_pending_orders'); alert('Cleared'); }
  });

  async function loadStaticOrders(){
    // static orders file is empty by default; for live orders we use the Netlify function.
    try{ const r = await fetch('/data/products.json'); if(!r.ok) return []; const j = await r.json(); return j.orders || []; } catch(e){ return []; }
  }

  function loadPending(){ return JSON.parse(localStorage.getItem('stellies_pending_orders')||'[]'); }

  async function loadOrders(){
    // try Netlify backend list
    let backend = ''; // set the list endpoint here if you want: e.g. '/.netlify/functions/order?action=list'
    let backendOrders = [];
    if(backend){
      try{ const r = await fetch(backend); if(r.ok) backendOrders = await r.json(); } catch(e){ console.warn(e); }
    }
    const staticOrders = await loadStaticOrders();
    const pending = loadPending();
    renderOrders(backendOrders.concat(staticOrders).concat(pending));
  }

  function renderOrders(rows){
    const body = document.getElementById('ordersBody'); body.innerHTML = '';
    if(!rows || rows.length===0){ body.innerHTML = '<tr><td colspan="8">No orders</td></tr>'; document.getElementById('summary').textContent='Orders:0'; return; }
    rows.forEach(o=>{
      const items = (o.items||[]).map(it=> `${it.qty}× ${it.itemName}${it.flavour? ' ('+it.flavour+')':''}`).join('; ');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="font-weight:700">${o.orderNumber||o.id||''}</td>
        <td>${o.name||o.customerName||''}</td>
        <td>${o.phone||''}</td>
        <td>${o.delivery||''}</td>
        <td style="white-space:pre-wrap;max-width:300px;">${items}</td>
        <td>R ${Number(o.total||0).toFixed(2)}</td>
        <td>${o.timestamp ? new Date(o.timestamp).toLocaleString() : (o.date? new Date(o.date).toLocaleString():'')}</td>
        <td>${o.packed ? 'Yes' : 'No'}</td>`;
      body.appendChild(tr);
    });
    const total = rows.reduce((s,r)=> s + Number(r.total||0), 0);
    document.getElementById('summary').textContent = `Orders: ${rows.length} · Revenue: R${total.toFixed(2)}`;
  }

  document.getElementById('refreshAdmin').addEventListener('click', loadOrders);
  document.getElementById('exportCSV').addEventListener('click', async ()=>{
    const staticOrders = await loadStaticOrders(); const pending = loadPending(); const rows = staticOrders.concat(pending);
    if(rows.length===0){ alert('No orders'); return; }
    const keys = Object.keys(rows[0]);
    const csv = [keys.join(',')];
    rows.forEach(r => csv.push(keys.map(k=>`"${(r[k]||'').toString().replace(/"/g,'""')}"`).join(',')));
    const uri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv.join('\n'));
    const a = document.createElement('a'); a.href=uri; a.download='stellies-orders.csv'; a.click();
  });
</script>
</body>
</html>
