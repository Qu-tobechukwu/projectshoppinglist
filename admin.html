<!doctype html>
<html>
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stellies — Admin</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .admin-header { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
    .admin-tools{ display:flex; gap:8px; align-items:center; margin-bottom:12px; }
    .admin-table { width:100%; border-collapse:collapse; }
    .admin-table th, .admin-table td { padding:8px; border-bottom:1px solid #f4efec; text-align:left; }
  </style>
</head>
<body>
  <div class="container">
    <div class="admin-header">
      <img src="logo.png" style="height:56px" alt="logo" />
      <div>
        <h2 style="margin:0;color:#ac2a13">Stellies Admin</h2>
        <div class="small">Static orders + pending local orders</div>
      </div>
    </div>

    <div class="admin-tools">
      <button id="refreshAdmin" class="btn">Refresh</button>
      <button id="exportOrders" class="btn ghost">Export CSV</button>
      <label class="small">Show:
        <select id="adminFilter">
          <option value="all">All</option>
          <option value="pending">Pending (local)</option>
          <option value="static">Static file</option>
        </select>
      </label>
    </div>

    <table class="admin-table" id="adminTable">
      <thead><tr><th>Order #</th><th>Name</th><th>Phone</th><th>Delivery</th><th>Items</th><th>R Total</th><th>Date</th></tr></thead>
      <tbody id="adminBody"><tr><td colspan="7">Loading…</td></tr></tbody>
    </table>
  </div>

  <script>
    async function loadStaticOrders(){
      try {
        const r = await fetch('./data/orders.json');
        return await r.json();
      } catch(err){
        return [];
      }
    }
    function loadLocalPending(){
      return JSON.parse(localStorage.getItem('stellies_pending_orders') || '[]');
    }
    function renderAdmin(){
      Promise.all([loadStaticOrders()]).then(([staticOrders])=>{
        const pending = loadLocalPending();
        const filter = document.getElementById('adminFilter').value;
        let rows = [];
        if(filter==='all'){ rows = staticOrders.concat(pending); }
        else if(filter==='pending'){ rows = pending; }
        else rows = staticOrders;
        const body = document.getElementById('adminBody');
        body.innerHTML = '';
        if(rows.length===0){ body.innerHTML = '<tr><td colspan="7">No orders</td></tr>'; return; }
        rows.forEach(o=>{
          const itemsStr = (o.items||[]).map(it=>`${it.quantity}x ${it.productId}${it.flavour? ' ('+it.flavour+')':''}`).join('; ');
          const tr = document.createElement('tr');
          tr.innerHTML = `<td style="font-weight:800">${o.id||o.orderNumber||''}</td>
            <td>${o.customerName||o.name||''}</td>
            <td>${o.phone||o.phone||''}</td>
            <td>${o.delivery||o.delivery||''}</td>
            <td style="white-space:pre-wrap;max-width:320px;">${itemsStr}</td>
            <td>R ${Number(o.total||0).toFixed(2)}</td>
            <td>${new Date(o.date||o.timestamp||'').toLocaleString()}</td>`;
          body.appendChild(tr);
        });
      });
    }
    document.getElementById('refreshAdmin').addEventListener('click', renderAdmin);
    document.getElementById('adminFilter').addEventListener('change', renderAdmin);
    document.getElementById('exportOrders').addEventListener('click', ()=>{
      // export combined
      Promise.all([loadStaticOrders()]).then(([staticOrders])=>{
        const pending = loadLocalPending();
        const rows = staticOrders.concat(pending);
        if(rows.length===0){ alert('No orders to export'); return; }
        const headers = Object.keys(rows[0]);
        const csv = [headers.join(',')];
        rows.forEach(r=>{
          csv.push(headers.map(h => `"${(r[h]||'').toString().replace(/"/g,'""')}"`).join(','));
        });
        const uri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv.join('\n'));
        const a = document.createElement('a'); a.href = uri; a.download = 'stellies-orders.csv'; a.click();
      });
    });
    renderAdmin();
  </script>
</body>
</html>
