<!doctype html>
<html>
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin — Golden Grove</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <main class="container admin-wrap">
    <div class="card">
      <h2>Admin sign-in</h2>
      <div class="muted">Enter password to view and manage orders</div>
      <div style="margin-top:8px; display:flex; gap:8px;">
        <input id="adminPw" type="password" placeholder="Password" />
        <button id="unlockBtn" class="btn">Unlock</button>
      </div>
    </div>

    <div id="adminUI" class="card" style="margin-top:12px; display:none">
      <h3>Orders</h3>
      <div id="summary" class="muted"></div>
      <table id="ordersTable">
        <thead><tr><th>Order #</th><th>Name</th><th>Phone</th><th>Delivery</th><th>Items</th><th>Total (R)</th><th>Date</th><th>Packed</th><th>Actions</th></tr></thead>
        <tbody id="ordersBody"><tr><td colspan="9">Loading…</td></tr></tbody>
      </table>
    </div>
  </main>

<script>
  async function sha256hex(s){ const enc=new TextEncoder().encode(s); const h=await crypto.subtle.digest('SHA-256', enc); return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
  // Hash for password 'forphoneuseemail@gmail.com' (so entering that will unlock)
  const ADMIN_HASH = '51d8fb68183ff49fa4c539d127879d4360584e197cb76b6901a3c55268748c9f';
  document.getElementById('unlockBtn').addEventListener('click', async ()=>{
    const v=document.getElementById('adminPw').value||'';
    if(!v) return alert('Enter password');
    const h = await sha256hex(v);
    if(h === ADMIN_HASH){ document.getElementById('adminUI').style.display='block'; loadOrders(); } else alert('Incorrect password');
  });

  async function loadOrders(){
    try {
      const res = await fetch('/.netlify/functions/order?action=list');
      const j = await res.json();
      const rows = j.orders || [];
      const tbody = document.getElementById('ordersBody'); tbody.innerHTML='';
      if(!rows.length){ tbody.innerHTML='<tr><td colspan="9">No orders</td></tr>'; document.getElementById('summary').textContent='Orders: 0'; return; }
      rows.forEach(r=>{
        const items = r.Items || r.items || '';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.OrderNumber||r.orderNumber||''}</td><td>${r.Name||r.name||''}</td><td>${r.Phone||r.phone||''}</td><td>${r.Delivery||r.delivery||''}</td><td style="white-space:pre-wrap">${items}</td><td>R ${Number(r.Total||r.total||0).toFixed(2)}</td><td>${r.Timestamp||r.timestamp||''}</td><td>${r.Packed||r.packed||''}</td><td><button class="btn small" onclick="markPacked('${r.OrderNumber||r.orderNumber||''}')">Mark packed</button></td>`;
        tbody.appendChild(tr);
      });
      const total = rows.reduce((s,r)=> s + Number(r.Total||r.total||0), 0);
      document.getElementById('summary').textContent = `Orders: ${rows.length} · Revenue: R${total.toFixed(2)}`;
    } catch(err){ console.error(err); alert('Could not load orders'); }
  }

  async function markPacked(orderNumber){
    if(!confirm('Mark order '+orderNumber+' as packed?')) return;
    try {
      const res = await fetch('/.netlify/functions/order', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ action:'markPacked', orderNumber: orderNumber }) });
      const j = await res.json();
      if(j.success) alert('Marked packed'); loadOrders();
      else alert('Error: '+(j.message||j.error));
    } catch(e){ console.error(e); alert('Failed'); }
  }
</script>
</body>
</html>
